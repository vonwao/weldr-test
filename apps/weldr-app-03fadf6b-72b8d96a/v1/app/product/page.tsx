'use client';

// @generated by Weldr.dev â€” entity page managed. Customize page layout in @custom regions or Next.js route overrides.

import { useMemo, useState } from 'react';
import { ProductList } from '@/components/entities/ProductList';
import { ProductForm } from '@/components/entities/ProductForm';
import { ProductDetail } from '@/components/entities/ProductDetail';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import {
  useProductList,
  useProductDetail,
  useCreateProduct,
  useUpdateProduct,
  useDeleteProduct,
} from '@/lib/generated/data/product';
import type { Product, ProductInput } from '@/lib/types';

export default function ProductPage() {
  const list = useProductList();
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [dialogView, setDialogView] = useState<'form' | 'detail'>('form');
  const [dialogOpen, setDialogOpen] = useState(false);

  const detail = useProductDetail(selectedId);

  const createAction = useCreateProduct({
    onSuccess: (record) => {
      void list.refresh();
      const id = (record as Product)?.id ?? null;
      setSelectedId(id);
      setDialogView('detail');
      setDialogOpen(true);
    },
  });

  const updateAction = useUpdateProduct({
    onSuccess: (record) => {
      void list.refresh();
      const id = (record as Product)?.id ?? selectedId;
      setSelectedId(id ?? null);
      setDialogView('detail');
      setDialogOpen(true);
    },
  });

  const deleteAction = useDeleteProduct({
    onSuccess: () => {
      void list.refresh();
      setDialogOpen(false);
      setDialogView('form');
      setSelectedId(null);
    },
  });

  const currentRecord = useMemo(() => {
    if (!selectedId) {
      return null;
    }
    return list.data?.find((item) => item.id === selectedId) ?? detail.data ?? null;
  }, [detail.data, list.data, selectedId]);

  const formAction = selectedId ? updateAction : createAction;
  const formError = formAction.error ? formAction.error.message : null;

  const resetActions = () => {
    createAction.reset();
    updateAction.reset();
    deleteAction.reset();
  };

  const handleCreate = () => {
    resetActions();
    setSelectedId(null);
    setDialogView('form');
    setDialogOpen(true);
  };

  const handleEdit = (item: Product) => {
    resetActions();
    setSelectedId(item.id);
    setDialogView('form');
    setDialogOpen(true);
  };

  const handleView = (item: Product) => {
    resetActions();
    setSelectedId(item.id);
    setDialogView('detail');
    setDialogOpen(true);
  };

  const handleDelete = async (item: Product) => {
    const result = await deleteAction.execute({ id: item.id });
    if (result.ok) {
      resetActions();
      setSelectedId(null);
      setDialogOpen(false);
    }
  };

  const handleCloseDialog = (open: boolean) => {
    if (!open) {
      setDialogOpen(false);
      setDialogView('form');
      resetActions();
    } else {
      setDialogOpen(true);
    }
  };

  const handleFormSubmit = async (values: ProductInput) => {
    if (selectedId) {
      const result = await updateAction.execute({ id: selectedId, ...values });
      if (result.ok) {
        resetActions();
        await list.refresh();
        setDialogView('detail');
        setDialogOpen(true);
      }
    } else {
      const result = await createAction.execute(values);
      if (result.ok) {
        const record = result.data as Product;
        resetActions();
        await list.refresh();
        setSelectedId(record?.id ?? null);
        setDialogView('detail');
        setDialogOpen(true);
      }
    }
  };

  return (
    <div className="container mx-auto py-8 space-y-6">
      {list.error ? (
        <div className="rounded border border-destructive/40 bg-destructive/5 px-4 py-2 text-sm text-destructive">
          {list.error.message}
        </div>
      ) : null}

      <ProductList
        items={list.data ?? []}
        isLoading={list.isLoading}
        onCreate={handleCreate}
        onView={handleView}
        onEdit={handleEdit}
        onDelete={(item) => {
          if (confirm('Delete this record?')) {
            void handleDelete(item);
          }
        }}
      />

      <Dialog open={dialogOpen} onOpenChange={handleCloseDialog}>
        <DialogContent className="sm:max-w-[640px]">
          {dialogView === 'form' && (
            <ProductForm
              initialData={currentRecord ?? undefined}
              onSubmit={handleFormSubmit}
              onCancel={() => handleCloseDialog(false)}
              isSubmitting={formAction.isLoading}
              error={formError}
            />
          )}

          {dialogView === 'detail' && selectedId ? (
            detail.isLoading ? (
              <div className="p-6 text-sm text-muted-foreground">Loading details...</div>
            ) : currentRecord ? (
              <ProductDetail
                item={currentRecord}
                onEdit={() => {
                  setDialogView('form');
                }}
                onDelete={() => void handleDelete(currentRecord)}
                isDeleting={deleteAction.isLoading}
              />
            ) : (
              <div className="p-6 text-sm text-muted-foreground">
                Record not found.
              </div>
            )
          ) : null}
        </DialogContent>
      </Dialog>
    </div>
  );
}
